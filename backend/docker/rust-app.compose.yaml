x-build-network: &build-network
  network: host

x-networks: &networks
  networks:
    - app_network

x-build-labels: &build-labels
  com.docker.compose.project: ${COMPOSE_PROJECT_NAME:?Docker Compose Config Error! COMPOSE_PROJECT_NAME is not set!}

x-build-args: &build-args
  APP_NAME: ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}
  APP_PORT: ${APP_PORT:-8080}
  ENV: ${ENV?Docker Compose Config Error! ENV is not set!}
  RUST_BINARY_NAME: ${RUST_BINARY_NAME?Docker Compose Config Error! RUST_BINARY_NAME is not set!}
  RUST_VERSION: ${RUST_VERSION:-1.83}
  RUST_BUILD_PROFILE: ${RUST_BUILD_PROFILE:-release}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  TARGET_PLATFORM: ${TARGET_PLATFORM:?Docker Compose Config Error! TARGET_PLATFORM is not set!}

services:
  # ----------------------
  # 1) App Service
  # ----------------------
  rust-app:
    build:
      context: .
      additional_contexts:
        devops-toolkit: ${DEVOPS_TOOLKIT_PATH?Docker Compose Config Error! DEVOPS_TOOLKIT_PATH is not set!}
      dockerfile: ${DEVOPS_TOOLKIT_PATH?Docker Compose Config Error! DEVOPS_TOOLKIT_PATH is not set!}/backend/docker/rust-app.Dockerfile
      target: dev
      <<: *build-network
      args:
        <<: *build-args
      labels:
        <<: *build-labels
        com.docker.compose.service: rust-app

      # Have to do this until there is a better option to control this from the compose cli
      platforms:
        - ${TARGET_PLATFORM:?Docker Compose Config Error! TARGET_PLATFORM is not set!}
    image: ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}
    container_name: ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}_instance
    environment:
      - ENV=${ENV}
      - PORT=${APP_PORT:-8080}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RUST_LOG=${LOG_LEVEL:-info}
      - RUST_BACKTRACE=1
    ports:
      - "${APP_HOST_PORT:-8080}:${APP_PORT:-8080}"
    command: ["cargo", "watch", "-x", "run"]
    volumes:
      - .:/app
      - rust-target:/app/target
      - rust-cargo-registry:/usr/local/cargo/registry
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${APP_PORT:-8080}/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      app_network:
        aliases:
          - ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}
    profiles:
      - unassigned

  # ----------------------
  # 2) App Service Health Check
  # ----------------------
  rust-app-health-check:
    build:
      context: .
      additional_contexts:
        devops-toolkit: ${DEVOPS_TOOLKIT_PATH?Docker Compose Config Error! DEVOPS_TOOLKIT_PATH is not set!}
      dockerfile: ${DEVOPS_TOOLKIT_PATH?Docker Compose Config Error! DEVOPS_TOOLKIT_PATH is not set!}/backend/docker/rust-app.Dockerfile
      target: health-check
      <<: *build-network
      args:
        APP_URL_FROM_ANYWHERE: ${APP_URL_FROM_ANYWHERE:-}
      labels:
        <<: *build-labels
        com.docker.compose.service: rust-app-health-check
    image: ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}-health-check
    container_name: ${APP_NAME?Docker Compose Config Error! APP_NAME is not set!}-health-check_instance
    profiles:
      - unassigned
    <<: *networks

# Rust build cache volumes - preserved across `make down`, removed by `make clean`
volumes:
  rust-target:
  rust-cargo-registry:

networks:
  app_network:
    external: true
    name: ${COMPOSE_NETWORK_NAME?Docker Compose Config Error! COMPOSE_NETWORK_NAME is not set!}
